# 用户注册

+ 先实现最基本的用户注册即`发送用户注册信息`，`读取解析存进数据库`，`返回响应`

## 用户模型

1. 先设计一个用户基本表

   ![](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221212173519565.png)

2. 利用`sea-orm-cli`来生成用户模型代码

   `.env`

   ```shell
   DATABASE_URL=protocol://postgres:123456@localhost/ava
   ```

   + `postgres` 用户名
   + `123456` 密码
   + `localhost` 数据库地址
   + `ava` 数据库

   运行命令

   ```shell
   sea-orm-cli generate entity  -o model/src/entity/
   ```

   ![image-20221212203422629](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221212203422629.png)

   默认生成`public`下面的除`seaql_migrations`表的entity

3. `model/src/entity/user.rs`

   根据表自动生成的代码如下:

   ```rust
   //! `SeaORM` Entity. Generated by sea-orm-codegen 0.10.4
   
   use sea_orm::entity::prelude::*;
   
   #[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]
   #[sea_orm(table_name = "user")]
   pub struct Model {
       #[sea_orm(primary_key, auto_increment = false)]
       pub id: String,
       pub username: String,
       pub phone: String,
       pub email: String,
       pub password: String,
   }
   
   #[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]
   pub enum Relation {}
   
   impl ActiveModelBehavior for ActiveModel {}
   
   ```

   后续我们就可以使用这些生成的代码进行`CRUD`操作



## 测试新增用户

+ 测试部分的代码不进行详细讲解，可以看下一节的内容看详细说明

`Cargo.toml`

```toml
[workspace]
members =[
    "app",
    "configs",
    "utils",
    "service",
    "model",
    "router",
    "migration",
    "api",
]

[workspace.package]
authors = ["shengj.sang <shengj.sang@icloud.com>"]
edition = "2021"
license = "MIT"
publish = false
repository = ""


[workspace.dependencies]
# basic
serde = "1"
serde_json = "1"

# web
axum = "0"
tokio = "1"

# config
once_cell = "1"
toml = "0.5"


# time
time = "0.3"
chrono = "0"

# log
tracing = "0.1"
tracing-appender = "0.2"
tracing-subscriber = "0.3"

# sea-orm
sea-orm = "0"

anyhow = "1"

```



### Api

`api/Cargo.toml`

```toml
[package]
name = "api"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
utils = {path = "../utils"}
service = {path = "../service"}
model = {path = "../model"}
sea-orm = {workspace = true}
tokio = {workspace = true,default-features =false,  features = ["rt-multi-thread", "macros", "parking_lot", "signal"]}
anyhow = {workspace = true}
axum = {workspace = true}
serde_json = {workspace = true}
serde = {workspace = true}

```

`api/src/user/mod.rs`

```rust
use axum::Json;
use serde_json::{json, Value};
use service::user::register;
use utils::db::{init, DB};

pub async fn create() -> Json<Value> {
    let db = DB.get_or_init(init).await;
    let res = register(db).await;

    match res {
        Ok(_x) => Json(json!({"data": 200 })),
        Err(_e) => Json(json!({"data": 404 })),
    }
}

```

`api/src/lib.rs`

```rust
pub mod user;
```



### Service

`service/Cargo.toml`

```toml
[package]
name = "service"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
model = {path = "../model"}
sea-orm = {workspace = true}
tokio = {workspace = true,default-features =false,  features = ["rt-multi-thread", "macros", "parking_lot", "signal"]}
anyhow = {workspace = true}
serde_json = {workspace = true}
serde = {workspace = true}

```

`service/src/user/mod.rs`

```rust
use anyhow::Result;
use model::entity::user;
use sea_orm::ActiveValue::Set;
use sea_orm::DatabaseConnection;
use sea_orm::EntityTrait;

pub async fn register(db: &DatabaseConnection) -> Result<String> {
    let user = user::ActiveModel {
        id: Set("1".to_string()),
        username: Set("jack".to_string()),
        phone: Set("+861234567809".to_string()),
        email: Set("123456@qq.cim".to_string()),
        password: Set("123456".to_string()),
    };

    user::Entity::insert(user).exec(db).await?;

    Ok("用户添加成功".to_string())
}

```

`service/src/lib.rs`

```rust
pub mod user;
```



### Router

`router/Cargo.toml`

```timl
[package]
name = "router"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
api = {path = "../api"}
axum = {workspace = true}

```

`router/lib.rs`

```rust
use api::user::create;
use axum::routing::get;
use axum::Router;

pub fn api() -> Router {
    Router::new().nest("/user", user_api())
}

fn user_api() -> Router {
    Router::new().route("/register", get(create)) // 注册
}

```



### App

`app/src/main.rs`

```rust
use axum::Router;
use configs::CFG;
use router::api;
use std::net::SocketAddr;
use std::str::FromStr;
use tracing::info;
use utils::log;

#[tokio::main]
async fn main() {
    // 初始化日志
    let _guard = log::init();
    info!("Starting");

    let app = Router::new().nest("/v1", api());

    let addr = SocketAddr::from_str(&CFG.server.address).unwrap();
    // 设置端口
    axum::Server::bind(&addr)
        // 服务启动
        .serve(app.into_make_service())
        .await
        .unwrap();
}

```



### git提交

```shell
git add .
git commit -m "新增user创建"
```



## 启动程序并发送请求

![](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221218121802480.png)

![image-20221218121824696](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221218121824696.png)



## 将User表存储

![image-20221218122247490](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221218122247490.png)

存储到`migration/sql/`下

![image-20221218122319153](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221218122319153.png)
