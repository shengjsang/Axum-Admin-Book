# 用户注册

+ 先实现最基本的用户注册即`发送用户注册信息`，`读取解析存进数据库`，`返回响应`

## 用户模型

1. 先设计一个用户基本表

   ![](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221212173519565.png)

2. 利用`sea-orm-cli`来生成用户模型代码

   `.env`

   ```shell
   DATABASE_URL=protocol://postgres:123456@localhost/ava
   ```

   + `postgres` 用户名
   + `123456` 密码
   + `localhost` 数据库地址
   + `ava` 数据库

   运行命令

   ```shell
   sea-orm-cli generate entity  -o model/src/entity/
   ```

   ![image-20221212203422629](https://repo-1256831547.cos.ap-shanghai.myqcloud.com/image-20221212203422629.png)

   默认生成`public`下面的除`seaql_migrations`表的entity

3. `model/src/entity/user.rs`

   根据表自动生成的代码如下:

   ```rust
   //! `SeaORM` Entity. Generated by sea-orm-codegen 0.10.4
   
   use sea_orm::entity::prelude::*;
   
   #[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]
   #[sea_orm(table_name = "user")]
   pub struct Model {
       #[sea_orm(primary_key, auto_increment = false)]
       pub id: String,
       pub username: String,
       pub phone: String,
       pub email: String,
       pub password: String,
   }
   
   #[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]
   pub enum Relation {}
   
   impl ActiveModelBehavior for ActiveModel {}
   
   ```

   后续我们就可以使用这些生成的代码进行`CRUD`操作



## 测试CRUD

### api

`api/Cargo.toml`

```toml
[package]
name = "api"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
utils = {path = "../utils"}
service = {path = "../service"}
model = {path = "../model"}
sea-orm = {workspace = true}
tokio = {workspace = true,default-features =false,  features = ["rt-multi-thread", "macros", "parking_lot", "signal"]}
anyhow = {workspace = true}
axum = {workspace = true}
serde_json = {workspace = true}
serde = {workspace = true}

```

`api/src/user/mod.rs`

```rust
use axum::Json;
use serde_json::{json, Value};
use service::user::register;
use utils::db::{init, DB};

pub async fn create() -> Json<Value> {
    let db = DB.get_or_init(init).await;
    let res = register(db).await;

    match res {
        Ok(_x) => Json(json!({"data": 200 })),
        Err(_e) => Json(json!({"data": 404 })),
    }
}

```

`api/src/lib.rs`

```rust
pub mod user;
```



### service

`service/Cargo.toml`

```toml
[package]
name = "service"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
model = {path = "../model"}
sea-orm = {workspace = true}
tokio = {workspace = true,default-features =false,  features = ["rt-multi-thread", "macros", "parking_lot", "signal"]}
anyhow = {workspace = true}
serde_json = {workspace = true}
serde = {workspace = true}

```

`service/src/user/mod.rs`

```rust
use anyhow::Result;
use model::entity::user;
use sea_orm::ActiveValue::Set;
use sea_orm::DatabaseConnection;
use sea_orm::EntityTrait;

pub async fn register(db: &DatabaseConnection) -> Result<String> {
    let user = user::ActiveModel {
        id: Set("1".to_string()),
        username: Set("jack".to_string()),
        phone: Set("+861234567809".to_string()),
        email: Set("123456@qq.cim".to_string()),
        password: Set("123456".to_string()),
    };

    user::Entity::insert(user).exec(db).await?;

    Ok("用户添加成功".to_string())
}

```

`service/src/lib.rs`

```rust
pub mod user;
```

